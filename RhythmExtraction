#rhythm extraction with Google Colab - here's to my non computer havers out there
from google.colab import drive
import music21
import csv
import pandas as pd
drive.mount('/content/drive')

"""
K279 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Piano_Sonata_n01_K279.mxl') #does not work
K279 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K279_2.mxl') #works - done

K545 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K545_1.mxl') #does not work
K545 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K545_2.mxl') #works - done

K457 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K457_1.mxl') #works - done

K189 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K189_1.mxl') #works badly - done

K331 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K331_1.mxl') #works - done

K570 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K570_1.mxl') #works - done

K576 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K576_1.mxl') #works - done

K310 = music21.converter.parse('/content/drive/MyDrive/MusicXML/K310_1.mxl') #works badly, part[1] not [0] - done

Op10No1 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op10No1_1.mxl') #works - done

Op49No2 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op49No2_1.mxl') #works, 1st mvmt only - done

Op13 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op13_1.mxl') #works - done

Op2No1 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op2No1_1.mxl') #works, 1st mvmt only - done

Op2No3 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op2No3_1.mxl') #works - done

Op81a = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op81a_1.mxl') #works, 1st mvmt only - done

Op78 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op78_1.mxl') #works - done

Op31No1 = music21.converter.parse('/content/drive/MyDrive/MusicXML/Op31No1_1.mxl') #works, 1st mvmt only - done
"""

def getMelody(part):
  """finds the melody or first voice of a part, and flattens it into the melody list"""
  melody = []
  for bar in part.getElementsByClass('Measure'):
    voices = bar.getElementsByClass('Voice')
    if voices:
      melody.extend(voices[0].notesAndRests)
    else:
      melody.extend(bar.notesAndRests)
  return melody
  
def separatePhrases(melody):
  """separates the melody into phrases, and converts the phrases into a matrix of durations"""
  phraseMatrix = []
  phrase = []
  for i in melody:
    if isinstance(i, music21.note.Note):
      if i.quarterLength>0:
        phrase.append(i.quarterLength)
      else:
        continue
    elif isinstance(i, music21.chord.Chord):
      if i.quarterLength>0:
        phrase.append(i.quarterLength)
      else:
        continue
    elif isinstance(i, music21.note.Rest):
      if len(phrase) > 0 and phrase not in phraseMatrix:
        phraseMatrix.append(phrase)
        phrase = []
      else:
        continue
  if phrase:
    phraseMatrix.append(phrase)
  return phraseMatrix

def padPhrases(phraseMatrix):
    """Pads phrases with None to ensure equal length."""
    maxLen = max(len(row) for row in phraseMatrix)
    paddedMatrix = [row + [None] * (maxLen - len(row)) for row in phraseMatrix]
    return paddedMatrix

def inspectPhrases(phraseMatrix):
  """a short function for inspecting the output before writing to a csv"""
  print(len(phraseMatrix))
  for i in phraseMatrix:
    print(i)

x = K457.parts[0]
y = getMelody(x)
phrases = separatePhrases(y)
paddedPhrases = padPhrases(phrases)
csv_path = "/content/drive/My Drive/MusicXML/K457.csv"

with open(csv_path, mode='w', newline='') as file:
    writer = csv.writer(file)
    writer.writerows(paddedPhrases)

df = pd.read_csv(csv_path, header=None)
print(df.head())
